<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Di√°rio Motor - Parkinson</title>

    <!-- jsPDF para gera√ß√£o de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --on-color: #28a745;
            --dys-np-color: #ffc107;      /* Discinesia n√£o problem√°tica - amarelo */
            --dys-p-color: #fd7e14;       /* Discinesia problem√°tica - laranja */
            --off-color: #dc3545;
            --sleep-color: #6c757d;
            --bg-color: #f4f6f9;
            --text-color: #333;
            --primary-color: #0056b3;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        /* TELA DE CADASTRO */
        .registration-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #0056b3 0%, #003d82 100%);
        }

        .registration-card {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 100%;
        }

        .registration-card h1 {
            color: var(--primary-color);
            margin: 0 0 10px 0;
            font-size: 1.8rem;
            text-align: center;
        }

        .registration-card p {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn-start {
            width: 100%;
            padding: 16px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .btn-start:hover {
            background: #003d82;
        }

        .btn-start:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* TELA PRINCIPAL DO DI√ÅRIO */
        .diary-screen {
            display: none;
            padding-bottom: 100px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-info h1 {
            margin: 0;
            font-size: 1.2rem;
        }

        .header-info .patient-info {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-top: 4px;
        }

        .header-status {
            text-align: right;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* CONTROLES */
        .controls-panel {
            background: white;
            margin: 15px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .time-display {
            text-align: center;
            margin-bottom: 15px;
        }

        .time-display .current-time {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .time-display .current-date {
            color: #666;
            font-size: 0.95rem;
        }

        .next-alarm {
            background: #e8f4fd;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
        }

        .next-alarm strong {
            color: var(--primary-color);
        }

        .btn-action {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .btn-end-day {
            background: var(--off-color);
            color: white;
        }

        .btn-manual {
            background: var(--primary-color);
            color: white;
        }

        /* LISTA DE AVALIA√á√ïES */
        .evaluations-panel {
            background: white;
            margin: 15px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .evaluations-panel h2 {
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .eval-count {
            background: var(--primary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .evaluation-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .evaluation-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            gap: 12px;
        }

        .evaluation-item:last-child {
            border-bottom: none;
        }

        .eval-time {
            font-weight: bold;
            min-width: 60px;
            color: #333;
        }

        .eval-status {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .eval-status.ON { background: var(--on-color); color: white; }
        .eval-status.DYS_NP { background: var(--dys-np-color); color: #000; }
        .eval-status.DYS_P { background: var(--dys-p-color); color: white; }
        .eval-status.OFF { background: var(--off-color); color: white; }

        .eval-type {
            font-size: 0.75rem;
            color: #888;
            margin-left: auto;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }

        /* MODAL DE ALARME / AVALIA√á√ÉO */
        .alarm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .alarm-modal.active {
            display: flex;
        }

        .alarm-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .alarm-icon {
            font-size: 4rem;
            margin-bottom: 10px;
        }

        .alarm-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .alarm-subtitle {
            color: #666;
            margin-bottom: 25px;
        }

        .alarm-time {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 25px;
        }

        .state-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .state-btn {
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.1s;
        }

        .state-btn:active {
            transform: scale(0.98);
        }

        .state-btn.on-btn { background: var(--on-color); color: white; }
        .state-btn.dys-np-btn { background: var(--dys-np-color); color: #000; }
        .state-btn.dys-p-btn { background: var(--dys-p-color); color: white; }
        .state-btn.off-btn { background: var(--off-color); color: white; }

        /* MODAL DE FINALIZA√á√ÉO */
        .finish-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }

        .finish-modal.active {
            display: flex;
        }

        .finish-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .stat-box {
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-box.on { background: rgba(40, 167, 69, 0.1); border: 2px solid var(--on-color); }
        .stat-box.dys { background: rgba(255, 193, 7, 0.1); border: 2px solid var(--dys-color); }
        .stat-box.off { background: rgba(220, 53, 69, 0.1); border: 2px solid var(--off-color); }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #666;
        }

        .email-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .email-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .sending-status {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .sending-status.loading {
            display: block;
            background: #e8f4fd;
            color: var(--primary-color);
        }

        .sending-status.success {
            display: block;
            background: rgba(40, 167, 69, 0.1);
            color: var(--on-color);
        }

        .sending-status.error {
            display: block;
            background: rgba(220, 53, 69, 0.1);
            color: var(--off-color);
        }

        /* MENU INFERIOR */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            z-index: 100;
        }

        .nav-btn {
            background: none;
            border: none;
            font-size: 0.8rem;
            color: #666;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 5px 20px;
        }

        .nav-btn.active {
            color: var(--primary-color);
        }

        .nav-btn span {
            font-size: 1.4rem;
            margin-bottom: 4px;
        }

        /* TABS */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* INSTRU√á√ïES */
        .instructions-panel {
            background: white;
            margin: 15px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .instructions-panel h2 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
        }

        .state-legend {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .legend-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .legend-color {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .legend-color.on { background: var(--on-color); }
        .legend-color.dys { background: var(--dys-color); }
        .legend-color.off { background: var(--off-color); }

        .legend-text strong {
            display: block;
            margin-bottom: 4px;
        }

        .legend-text span {
            font-size: 0.9rem;
            color: #666;
        }

        /* CONFIGURA√á√ïES */
        .config-panel {
            background: white;
            margin: 15px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .config-item {
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .config-item:last-child {
            border-bottom: none;
        }

        .config-item label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .config-item input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .btn-danger {
            background: var(--off-color);
            color: white;
            border: none;
            padding: 14px;
            width: 100%;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 15px;
        }

        /* Som do alarme visual */
        .alarm-visual {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-color);
            opacity: 0;
            pointer-events: none;
            z-index: 9998;
            animation: none;
        }

        .alarm-visual.flashing {
            animation: flash 0.5s ease-in-out 3;
        }

        @keyframes flash {
            0%, 100% { opacity: 0; }
            50% { opacity: 0.3; }
        }

        /* Responsivo */
        @media (max-width: 400px) {
            .registration-card {
                padding: 25px;
            }

            .alarm-card {
                padding: 20px;
            }

            .summary-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<!-- Som do Alarme -->
<audio id="alarm-sound" preload="auto" loop>
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
</audio>

<!-- Efeito visual do alarme -->
<div class="alarm-visual" id="alarm-visual"></div>

<!-- TELA DE CADASTRO -->
<div class="registration-screen" id="registration-screen">
    <div class="registration-card">
        <h1>Di√°rio Motor</h1>
        <p>Parkinson - Monitoramento de Estado Cl√≠nico</p>

        <form id="registration-form">
            <div class="form-group">
                <label for="patient-name">Nome Completo</label>
                <input type="text" id="patient-name" placeholder="Digite seu nome completo" required>
            </div>

            <div class="form-group">
                <label for="patient-cpf">CPF</label>
                <input type="text" id="patient-cpf" placeholder="000.000.000-00" required maxlength="14">
            </div>

            <div class="form-group">
                <label for="destination-email">E-mail para Envio do Relat√≥rio</label>
                <input type="email" id="destination-email" placeholder="medico@exemplo.com" required>
            </div>

            <button type="submit" class="btn-start" id="btn-start-diary">
                INICIAR DI√ÅRIO
            </button>
        </form>

        <p style="font-size: 0.8rem; color: #888; margin-top: 20px;">
            Ao iniciar, voc√™ ser√° solicitado a permitir notifica√ß√µes para os alarmes de avalia√ß√£o.
        </p>
    </div>
</div>

<!-- TELA PRINCIPAL DO DI√ÅRIO -->
<div class="diary-screen" id="diary-screen">
    <header>
        <div class="header-content">
            <div class="header-info">
                <h1>Di√°rio Motor</h1>
                <div class="patient-info" id="header-patient-info">Paciente</div>
            </div>
            <div class="header-status">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>Ativo</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Tab: Di√°rio -->
    <div id="tab-diary" class="tab-content active">
        <div class="controls-panel">
            <div class="time-display">
                <div class="current-time" id="current-time">00:00</div>
                <div class="current-date" id="current-date">Carregando...</div>
            </div>

            <div class="next-alarm" id="next-alarm-display">
                Pr√≥xima avalia√ß√£o em: <strong id="next-alarm-time">--:--</strong>
            </div>

            <button class="btn-action btn-manual" onclick="showAlarmModal('manual')">
                Registrar Avalia√ß√£o Agora
            </button>

            <button class="btn-action btn-end-day" onclick="showFinishModal()">
                Finalizar Dia (Ir Dormir)
            </button>
        </div>

        <div class="evaluations-panel">
            <h2>
                Avalia√ß√µes de Hoje
                <span class="eval-count" id="eval-count">0</span>
            </h2>

            <div class="evaluation-list" id="evaluation-list">
                <div class="empty-state">
                    Nenhuma avalia√ß√£o registrada ainda.<br>
                    A primeira avalia√ß√£o (basal) ser√° solicitada em breve.
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: Instru√ß√µes -->
    <div id="tab-info" class="tab-content">
        <div class="instructions-panel">
            <h2>Como usar o Di√°rio</h2>
            <p>A cada 30 minutos, um alarme aparecer√° pedindo que voc√™ informe seu estado cl√≠nico atual. Responda como est√° se sentindo <strong>naquele momento</strong>.</p>

            <h3 style="margin-top: 20px; margin-bottom: 15px;">Estados Cl√≠nicos:</h3>

            <div class="state-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--on-color);">ON</div>
                    <div class="legend-text">
                        <strong>ON - Estou Bem</strong>
                        <span>Mobilidade boa ou praticamente normal. Sem movimentos involunt√°rios.</span>
                    </div>
                </div>

                <div class="legend-item">
                    <div class="legend-color" style="background: var(--dys-np-color);">„Ä∞Ô∏è</div>
                    <div class="legend-text">
                        <strong>Discinesia Leve</strong>
                        <span>Movimentos involunt√°rios presentes, mas <strong>n√£o incomodam</strong>. Consigo fazer minhas atividades.</span>
                    </div>
                </div>

                <div class="legend-item">
                    <div class="legend-color" style="background: var(--dys-p-color); color: white;">‚ö†Ô∏è</div>
                    <div class="legend-text">
                        <strong>Discinesia que Incomoda</strong>
                        <span>Movimentos involunt√°rios que <strong>atrapalham</strong> minhas atividades. Desconfort√°vel.</span>
                    </div>
                </div>

                <div class="legend-item">
                    <div class="legend-color" style="background: var(--off-color); color: white;">OFF</div>
                    <div class="legend-text">
                        <strong>OFF - Travado</strong>
                        <span>Rigidez, lentid√£o marcante ou imobilidade. Medica√ß√£o n√£o est√° funcionando.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: Configura√ß√µes -->
    <div id="tab-config" class="tab-content">
        <div class="config-panel">
            <h2>Configura√ß√µes</h2>

            <div class="config-item">
                <label>E-mail para Envio</label>
                <input type="email" id="config-email" placeholder="medico@exemplo.com">
            </div>

            <div class="config-item">
                <label>Intervalo entre Avalia√ß√µes (minutos)</label>
                <input type="number" id="config-interval" value="30" min="5" max="120">
            </div>

            <button class="btn-action btn-manual" onclick="saveConfig()">
                Salvar Configura√ß√µes
            </button>

            <button class="btn-danger" onclick="resetAllData()">
                Reiniciar Tudo
            </button>
        </div>

        <div class="config-panel">
            <h2>Exportar Dados Manualmente</h2>
            <button class="btn-action btn-manual" onclick="downloadCSV()">
                Baixar CSV
            </button>
            <button class="btn-action btn-manual" style="background: #28a745;" onclick="downloadJSON()">
                Baixar JSON
            </button>
            <button class="btn-action btn-manual" style="background: #dc3545;" onclick="downloadPDF()">
                Baixar PDF
            </button>
        </div>
    </div>

    <!-- Menu Inferior -->
    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="switchTab('tab-diary', this)">
            <span>üìä</span>
            Di√°rio
        </button>
        <button class="nav-btn" onclick="switchTab('tab-info', this)">
            <span>‚ÑπÔ∏è</span>
            Instru√ß√µes
        </button>
        <button class="nav-btn" onclick="switchTab('tab-config', this)">
            <span>‚öôÔ∏è</span>
            Config
        </button>
    </nav>
</div>

<!-- MODAL DE ALARME / AVALIA√á√ÉO -->
<div class="alarm-modal" id="alarm-modal">
    <div class="alarm-card">
        <div class="alarm-icon" id="alarm-icon">‚è∞</div>
        <div class="alarm-title" id="alarm-title">Hora da Avalia√ß√£o!</div>
        <div class="alarm-subtitle" id="alarm-subtitle">Como voc√™ est√° se sentindo agora?</div>
        <div class="alarm-time" id="alarm-current-time">00:00:00</div>

        <div class="state-buttons">
            <button class="state-btn on-btn" onclick="submitEvaluation('ON')">
                <span>üòä</span> ON - Estou Bem
            </button>
            <button class="state-btn dys-np-btn" onclick="submitEvaluation('DYS_NP')">
                <span>„Ä∞Ô∏è</span> Discinesia Leve
            </button>
            <button class="state-btn dys-p-btn" onclick="submitEvaluation('DYS_P')">
                <span>‚ö†Ô∏è</span> Discinesia que Incomoda
            </button>
            <button class="state-btn off-btn" onclick="submitEvaluation('OFF')">
                <span>üê¢</span> OFF - Travado
            </button>
        </div>
    </div>
</div>

<!-- MODAL DE FINALIZA√á√ÉO -->
<div class="finish-modal" id="finish-modal">
    <div class="finish-card">
        <div class="alarm-icon">üåô</div>
        <div class="alarm-title">Finalizar o Dia</div>
        <div class="alarm-subtitle">Resumo das suas avalia√ß√µes de hoje</div>

        <!-- M√âTRICAS CL√çNICAS PRINCIPAIS -->
        <div style="background: #e8f4fd; border-radius: 12px; padding: 15px; margin-bottom: 15px; text-align: left;">
            <p style="font-weight: bold; color: #0056b3; margin: 0 0 10px 0; text-align: center;">M√âTRICAS CL√çNICAS</p>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #28a745; color: white; border-radius: 6px;">
                    <span>Tempo ON sem discinesia problem√°tica</span>
                    <strong id="metric-on-good">0h</strong>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #fd7e14; color: white; border-radius: 6px;">
                    <span>Tempo ON com discinesia problem√°tica</span>
                    <strong id="metric-on-bad">0h</strong>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #dc3545; color: white; border-radius: 6px;">
                    <span>Tempo OFF</span>
                    <strong id="metric-off">0h</strong>
                </div>
            </div>
        </div>

        <!-- CONTAGEM DETALHADA -->
        <div class="summary-stats" style="grid-template-columns: repeat(4, 1fr);">
            <div class="stat-box" style="background: rgba(40, 167, 69, 0.1); border: 2px solid var(--on-color);">
                <div class="stat-number" id="summary-on">0</div>
                <div class="stat-label">ON</div>
            </div>
            <div class="stat-box" style="background: rgba(255, 193, 7, 0.1); border: 2px solid var(--dys-np-color);">
                <div class="stat-number" id="summary-dys-np">0</div>
                <div class="stat-label">Disc. Leve</div>
            </div>
            <div class="stat-box" style="background: rgba(253, 126, 20, 0.1); border: 2px solid var(--dys-p-color);">
                <div class="stat-number" id="summary-dys-p">0</div>
                <div class="stat-label">Disc. Problem.</div>
            </div>
            <div class="stat-box" style="background: rgba(220, 53, 69, 0.1); border: 2px solid var(--off-color);">
                <div class="stat-number" id="summary-off">0</div>
                <div class="stat-label">OFF</div>
            </div>
        </div>

        <p style="color: #666; font-size: 0.9rem;">
            Total de avalia√ß√µes: <strong id="summary-total">0</strong><br>
            Tempo de vig√≠lia: <strong id="summary-duration">0h</strong>
        </p>

        <div class="email-section">
            <p style="font-weight: 600; margin-bottom: 5px;">E-mail do m√©dico:</p>
            <p style="color: #666; font-size: 0.8rem; margin-bottom: 10px;">
                O relat√≥rio completo ser√° enviado com todos os dados.
            </p>
            <input type="email" class="email-input" id="finish-email" placeholder="medico@exemplo.com">

            <button class="btn-action btn-manual" onclick="finishDayAndSend()" style="font-size: 1.1rem; padding: 18px;">
                ENVIAR RELAT√ìRIO
            </button>

            <button class="btn-action" style="background: #6c757d; color: white;" onclick="closeFinishModal()">
                Continuar Registrando
            </button>

            <div class="sending-status" id="sending-status"></div>
        </div>
    </div>
</div>

<script>
/**
 * CONFIGURA√á√ÉO DO FORMSUBMIT (https://formsubmit.co)
 *
 * FormSubmit √© um servi√ßo GRATUITO e SEM LIMITES para envio de emails.
 *
 * Como configurar:
 * 1. Na primeira vez que enviar, voc√™ receber√° um email de confirma√ß√£o
 * 2. Clique no link de confirma√ß√£o
 * 3. Ap√≥s confirmar, todos os envios para aquele email funcionar√£o automaticamente
 *
 * Vantagens sobre EmailJS:
 * - Gratuito e sem limite de envios
 * - N√£o precisa criar conta
 * - Configura√ß√£o autom√°tica
 */
const FORMSUBMIT_CONFIG = {
    // Endpoint base do FormSubmit
    endpoint: 'https://formsubmit.co/ajax/'
};

/**
 * ESTADO DA APLICA√á√ÉO
 */
const STORAGE_KEY = 'parkinson_diary_v2';

let appState = {
    patient: {
        name: '',
        cpf: '',
        email: ''
    },
    config: {
        intervalMinutes: 30,
        destinationEmail: ''
    },
    session: {
        startTime: null,
        isActive: false,
        lastAlarmTime: null
    },
    evaluations: []  // Array de { timestamp, status, type }
};

let alarmInterval = null;
let clockInterval = null;
let currentEvalType = 'regular';  // 'basal', 'regular', 'manual'

/**
 * INICIALIZA√á√ÉO
 */
document.addEventListener('DOMContentLoaded', () => {
    loadState();

    // Se j√° tem sess√£o ativa, ir direto para o di√°rio
    if (appState.session.isActive && appState.patient.name) {
        showDiaryScreen();
    }

    // Configurar m√°scara do CPF
    document.getElementById('patient-cpf').addEventListener('input', formatCPF);

    // Configurar formul√°rio de registro
    document.getElementById('registration-form').addEventListener('submit', handleRegistration);

    // Atualizar rel√≥gio
    updateClock();
    clockInterval = setInterval(updateClock, 1000);
});

/**
 * FORMATA√á√ÉO DO CPF
 */
function formatCPF(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 11) value = value.slice(0, 11);

    if (value.length > 9) {
        value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    } else if (value.length > 6) {
        value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
    } else if (value.length > 3) {
        value = value.replace(/(\d{3})(\d{1,3})/, '$1.$2');
    }

    e.target.value = value;
}

/**
 * REGISTRO DO PACIENTE
 */
function handleRegistration(e) {
    e.preventDefault();

    const name = document.getElementById('patient-name').value.trim();
    const cpf = document.getElementById('patient-cpf').value.trim();
    const email = document.getElementById('destination-email').value.trim();

    if (!name || !cpf || !email) {
        alert('Por favor, preencha todos os campos.');
        return;
    }

    // Validar CPF (formato b√°sico)
    if (cpf.replace(/\D/g, '').length !== 11) {
        alert('CPF inv√°lido. Digite os 11 d√≠gitos.');
        return;
    }

    // Salvar dados do paciente
    appState.patient = { name, cpf, email };
    appState.config.destinationEmail = email;
    appState.session = {
        startTime: new Date().toISOString(),
        isActive: true,
        lastAlarmTime: null
    };
    appState.evaluations = [];

    saveState();

    // Solicitar permiss√£o de notifica√ß√£o
    requestNotificationPermission().then(() => {
        showDiaryScreen();

        // Mostrar avalia√ß√£o basal imediatamente
        setTimeout(() => {
            showAlarmModal('basal');
        }, 1000);
    });
}

/**
 * PERMISS√ÉO DE NOTIFICA√á√ÉO
 */
async function requestNotificationPermission() {
    if (!("Notification" in window)) {
        alert("Seu navegador n√£o suporta notifica√ß√µes. Os alarmes aparecer√£o apenas na tela.");
        return;
    }

    const permission = await Notification.requestPermission();
    if (permission === "granted") {
        new Notification("Di√°rio Motor Ativado", {
            body: "Voc√™ receber√° lembretes a cada 30 minutos.",
            icon: "https://cdn-icons-png.flaticon.com/512/2966/2966327.png"
        });
    }
}

/**
 * MOSTRAR TELA DO DI√ÅRIO
 */
function showDiaryScreen() {
    document.getElementById('registration-screen').style.display = 'none';
    document.getElementById('diary-screen').style.display = 'block';

    // Atualizar header com info do paciente
    document.getElementById('header-patient-info').textContent =
        `${appState.patient.name} | CPF: ${appState.patient.cpf}`;

    // Atualizar email nas configura√ß√µes
    document.getElementById('config-email').value = appState.config.destinationEmail;
    document.getElementById('finish-email').value = appState.config.destinationEmail;

    // Renderizar lista de avalia√ß√µes
    renderEvaluationList();

    // Iniciar sistema de alarmes
    startAlarmSystem();
}

/**
 * SISTEMA DE ALARMES
 */
function startAlarmSystem() {
    // Verificar a cada minuto se √© hora do alarme
    checkForAlarm(); // Verificar imediatamente
    alarmInterval = setInterval(checkForAlarm, 60000); // Depois a cada minuto

    updateNextAlarmDisplay();
}

function checkForAlarm() {
    const now = new Date();
    const minutes = now.getMinutes();
    const intervalMinutes = appState.config.intervalMinutes || 30;

    // Alarme toca quando os minutos s√£o m√∫ltiplos do intervalo (0, 30 para 30min)
    if (minutes % intervalMinutes === 0) {
        const alarmKey = `${now.getHours()}:${minutes}`;

        // Evitar alarmes duplicados no mesmo minuto
        if (appState.session.lastAlarmTime !== alarmKey) {
            appState.session.lastAlarmTime = alarmKey;
            saveState();
            triggerAlarm();
        }
    }

    updateNextAlarmDisplay();
}

function triggerAlarm() {
    // Tocar som
    const audio = document.getElementById('alarm-sound');
    audio.currentTime = 0;
    audio.play().catch(e => console.log("Audio bloqueado - intera√ß√£o necess√°ria"));

    // Flash visual
    const visual = document.getElementById('alarm-visual');
    visual.classList.add('flashing');
    setTimeout(() => visual.classList.remove('flashing'), 2000);

    // Enviar notifica√ß√£o do sistema
    if (Notification.permission === "granted") {
        const notif = new Notification("Hora da Avalia√ß√£o!", {
            body: "Como voc√™ est√° se sentindo agora?",
            icon: "https://cdn-icons-png.flaticon.com/512/2966/2966327.png",
            requireInteraction: true,
            tag: 'parkinson-alarm'
        });

        notif.onclick = () => {
            window.focus();
            notif.close();
        };
    }

    // Mostrar modal
    showAlarmModal('regular');
}

function updateNextAlarmDisplay() {
    const now = new Date();
    const intervalMinutes = appState.config.intervalMinutes || 30;

    // Calcular pr√≥ximo hor√°rio de alarme
    const currentMinutes = now.getHours() * 60 + now.getMinutes();
    const nextAlarmMinutes = Math.ceil((currentMinutes + 1) / intervalMinutes) * intervalMinutes;

    const nextHour = Math.floor(nextAlarmMinutes / 60) % 24;
    const nextMin = nextAlarmMinutes % 60;

    document.getElementById('next-alarm-time').textContent =
        `${String(nextHour).padStart(2, '0')}:${String(nextMin).padStart(2, '0')}`;
}

/**
 * MODAL DE AVALIA√á√ÉO
 */
function showAlarmModal(type = 'regular') {
    currentEvalType = type;

    const modal = document.getElementById('alarm-modal');
    const icon = document.getElementById('alarm-icon');
    const title = document.getElementById('alarm-title');
    const subtitle = document.getElementById('alarm-subtitle');

    if (type === 'basal') {
        icon.textContent = 'üåÖ';
        title.textContent = 'Avalia√ß√£o Basal';
        subtitle.textContent = 'Como voc√™ est√° se sentindo ao acordar?';
    } else if (type === 'manual') {
        icon.textContent = 'üìù';
        title.textContent = 'Avalia√ß√£o Manual';
        subtitle.textContent = 'Registre seu estado atual:';
    } else {
        icon.textContent = '‚è∞';
        title.textContent = 'Hora da Avalia√ß√£o!';
        subtitle.textContent = 'Como voc√™ est√° se sentindo agora?';
    }

    // Atualizar hor√°rio no modal
    updateAlarmModalTime();

    modal.classList.add('active');

    // Tocar som se for alarme regular
    if (type === 'regular') {
        const audio = document.getElementById('alarm-sound');
        audio.play().catch(() => {});
    }
}

function updateAlarmModalTime() {
    const now = new Date();
    document.getElementById('alarm-current-time').textContent =
        now.toLocaleTimeString('pt-BR');
}

function closeAlarmModal() {
    const modal = document.getElementById('alarm-modal');
    modal.classList.remove('active');

    // Parar som
    const audio = document.getElementById('alarm-sound');
    audio.pause();
    audio.currentTime = 0;
}

/**
 * SUBMETER AVALIA√á√ÉO
 */
function submitEvaluation(status) {
    const now = new Date();

    const evaluation = {
        timestamp: now.toISOString(),
        timeFormatted: now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
        dateFormatted: now.toLocaleDateString('pt-BR'),
        status: status,
        type: currentEvalType
    };

    appState.evaluations.push(evaluation);
    saveState();

    closeAlarmModal();
    renderEvaluationList();

    // Feedback visual
    showToast(`Avalia√ß√£o registrada: ${getStatusLabel(status)}`);
}

function getStatusLabel(status) {
    const labels = {
        'ON': 'ON (Bem)',
        'DYS_NP': 'Discinesia Leve',
        'DYS_P': 'Discinesia Problem√°tica',
        'OFF': 'OFF (Travado)'
    };
    return labels[status] || status;
}

/**
 * CALCULAR M√âTRICAS CL√çNICAS
 * Calcula m√©tricas baseadas nos timestamps reais das avalia√ß√µes
 * Cada avalia√ß√£o representa o estado do paciente AT√â a pr√≥xima avalia√ß√£o
 */
function calculateClinicalMetrics() {
    const intervalMinutes = appState.config.intervalMinutes || 30;

    // Se n√£o houver avalia√ß√µes, retornar zeros
    if (appState.evaluations.length === 0) {
        return {
            counts: { ON: 0, DYS_NP: 0, DYS_P: 0, OFF: 0 },
            total: 0,
            intervalMinutes,
            timeOnGood: '0.0',
            timeOnBad: '0.0',
            timeOff: '0.0',
            totalTime: '0.0',
            pctOnGood: '0.0',
            pctOnBad: '0.0',
            pctOff: '0.0'
        };
    }

    // Ordenar avalia√ß√µes por timestamp
    const sortedEvals = [...appState.evaluations].sort((a, b) =>
        new Date(a.timestamp) - new Date(b.timestamp)
    );

    // Inicializar tempos em milissegundos
    let timeOn = 0;      // ON sem discinesia
    let timeDysNP = 0;   // Discinesia n√£o problem√°tica
    let timeDysP = 0;    // Discinesia problem√°tica
    let timeOff = 0;     // OFF

    // Contar avalia√ß√µes
    const counts = { ON: 0, DYS_NP: 0, DYS_P: 0, OFF: 0 };

    // Calcular tempo para cada avalia√ß√£o baseado no intervalo at√© a pr√≥xima
    for (let i = 0; i < sortedEvals.length; i++) {
        const current = sortedEvals[i];
        const currentTime = new Date(current.timestamp);

        // Contar a avalia√ß√£o
        if (counts.hasOwnProperty(current.status)) {
            counts[current.status]++;
        }

        // Determinar o fim do per√≠odo desta avalia√ß√£o
        let periodEnd;
        if (i < sortedEvals.length - 1) {
            // Se h√° pr√≥xima avalia√ß√£o, o per√≠odo vai at√© ela
            periodEnd = new Date(sortedEvals[i + 1].timestamp);
        } else {
            // √öltima avalia√ß√£o: per√≠odo vai at√© agora (ou intervalo padr√£o, o que for menor)
            const now = new Date();
            const maxEnd = new Date(currentTime.getTime() + intervalMinutes * 60 * 1000);
            periodEnd = now < maxEnd ? now : maxEnd;
        }

        // Calcular dura√ß√£o em milissegundos
        const duration = periodEnd - currentTime;

        // Adicionar ao tempo do estado correspondente
        switch (current.status) {
            case 'ON':
                timeOn += duration;
                break;
            case 'DYS_NP':
                timeDysNP += duration;
                break;
            case 'DYS_P':
                timeDysP += duration;
                break;
            case 'OFF':
                timeOff += duration;
                break;
        }
    }

    // Converter para horas
    const msToHours = ms => ms / (1000 * 60 * 60);

    const timeOnGoodHours = msToHours(timeOn + timeDysNP);  // ON sem discinesia problem√°tica
    const timeOnBadHours = msToHours(timeDysP);             // ON com discinesia problem√°tica
    const timeOffHours = msToHours(timeOff);                // OFF
    const totalTimeHours = timeOnGoodHours + timeOnBadHours + timeOffHours;

    // Calcular percentuais
    const pctOnGood = totalTimeHours > 0 ? (timeOnGoodHours / totalTimeHours * 100) : 0;
    const pctOnBad = totalTimeHours > 0 ? (timeOnBadHours / totalTimeHours * 100) : 0;
    const pctOff = totalTimeHours > 0 ? (timeOffHours / totalTimeHours * 100) : 0;

    return {
        counts,
        total: sortedEvals.length,
        intervalMinutes,
        // Tempos em horas
        timeOnGood: timeOnGoodHours.toFixed(1),
        timeOnBad: timeOnBadHours.toFixed(1),
        timeOff: timeOffHours.toFixed(1),
        totalTime: totalTimeHours.toFixed(1),
        // Percentuais
        pctOnGood: pctOnGood.toFixed(1),
        pctOnBad: pctOnBad.toFixed(1),
        pctOff: pctOff.toFixed(1)
    };
}

/**
 * RENDERIZAR LISTA DE AVALIA√á√ïES
 */
function renderEvaluationList() {
    const container = document.getElementById('evaluation-list');
    const count = document.getElementById('eval-count');

    count.textContent = appState.evaluations.length;

    if (appState.evaluations.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                Nenhuma avalia√ß√£o registrada ainda.<br>
                A primeira avalia√ß√£o (basal) ser√° solicitada em breve.
            </div>
        `;
        return;
    }

    // Ordenar por timestamp (mais recente primeiro)
    const sorted = [...appState.evaluations].reverse();

    container.innerHTML = sorted.map(eval => {
        const typeLabels = {
            'basal': 'Basal',
            'regular': 'Autom√°tica',
            'manual': 'Manual'
        };

        return `
            <div class="evaluation-item">
                <span class="eval-time">${eval.timeFormatted}</span>
                <span class="eval-status ${eval.status}">${getStatusLabel(eval.status)}</span>
                <span class="eval-type">${typeLabels[eval.type] || 'Regular'}</span>
            </div>
        `;
    }).join('');
}

/**
 * MODAL DE FINALIZA√á√ÉO
 */
function showFinishModal() {
    if (appState.evaluations.length === 0) {
        alert('Nenhuma avalia√ß√£o foi registrada ainda. Fa√ßa pelo menos uma avalia√ß√£o antes de finalizar.');
        return;
    }

    // Calcular m√©tricas cl√≠nicas
    const metrics = calculateClinicalMetrics();

    // Atualizar m√©tricas principais
    document.getElementById('metric-on-good').textContent = `${metrics.timeOnGood}h (${metrics.pctOnGood}%)`;
    document.getElementById('metric-on-bad').textContent = `${metrics.timeOnBad}h (${metrics.pctOnBad}%)`;
    document.getElementById('metric-off').textContent = `${metrics.timeOff}h (${metrics.pctOff}%)`;

    // Atualizar contagens
    document.getElementById('summary-on').textContent = metrics.counts.ON;
    document.getElementById('summary-dys-np').textContent = metrics.counts.DYS_NP;
    document.getElementById('summary-dys-p').textContent = metrics.counts.DYS_P;
    document.getElementById('summary-off').textContent = metrics.counts.OFF;
    document.getElementById('summary-total').textContent = metrics.total;
    document.getElementById('summary-duration').textContent = `${metrics.totalTime}h`;

    // Preencher email
    document.getElementById('finish-email').value = appState.config.destinationEmail;

    document.getElementById('finish-modal').classList.add('active');
}

function closeFinishModal() {
    document.getElementById('finish-modal').classList.remove('active');
    document.getElementById('sending-status').className = 'sending-status';
    document.getElementById('sending-status').textContent = '';
}

/**
 * FINALIZAR DIA E ENVIAR EMAIL
 * Envia relat√≥rio completo por email (dados CSV inclu√≠dos no corpo)
 */
async function finishDayAndSend() {
    const email = document.getElementById('finish-email').value.trim();

    if (!email) {
        alert('Por favor, informe o e-mail de destino.');
        return;
    }

    const statusEl = document.getElementById('sending-status');
    statusEl.className = 'sending-status loading';
    statusEl.textContent = 'Enviando relat√≥rio para o m√©dico...';

    try {
        const emailSent = await sendEmail(email);

        if (emailSent) {
            statusEl.className = 'sending-status success';
            statusEl.innerHTML = `
                <strong>Relat√≥rio enviado com sucesso!</strong><br>
                <small>O m√©dico receber√° todos os dados por email.</small>
            `;

            // Marcar sess√£o como finalizada
            appState.session.isActive = false;
            appState.session.endTime = new Date().toISOString();
            saveState();

            // Reiniciar para nova sess√£o
            setTimeout(() => {
                if (confirm('Deseja iniciar um novo dia de monitoramento?')) {
                    resetForNewDay();
                }
            }, 3000);
        } else {
            // Email falhou - provavelmente primeira vez (precisa confirmar)
            statusEl.className = 'sending-status error';
            statusEl.innerHTML = `
                <strong>Aten√ß√£o: Confirma√ß√£o necess√°ria</strong><br>
                <small>
                    Na primeira vez, o m√©dico precisa confirmar o email.<br>
                    Um link de confirma√ß√£o foi enviado para: <strong>${email}</strong><br>
                    Ap√≥s confirmar, tente enviar novamente.
                </small>
            `;
        }

    } catch (error) {
        console.error('Erro ao finalizar:', error);
        statusEl.className = 'sending-status error';
        statusEl.innerHTML = `
            <strong>Erro ao enviar</strong><br>
            <small>Verifique sua conex√£o com a internet e tente novamente.</small>
        `;
    }
}

/**
 * ENVIAR EMAIL VIA FORMSUBMIT
 * Envia relat√≥rio completo com m√©tricas cl√≠nicas e dados CSV
 */
async function sendEmail(toEmail) {
    try {
        // Calcular m√©tricas cl√≠nicas
        const metrics = calculateClinicalMetrics();

        // Gerar CSV completo como texto
        const csvContent = generateCSVContent();
        const csvLines = csvContent.split('\n').filter(line => line.trim());
        const csvFormatted = csvLines.join('\n');

        // Criar lista de avalia√ß√µes em texto simples
        const evalListText = appState.evaluations.map(eval => {
            const typeLabel = eval.type === 'basal' ? 'Basal' : eval.type === 'manual' ? 'Manual' : 'Auto';
            return `${eval.dateFormatted} ${eval.timeFormatted} | ${getStatusLabel(eval.status)} | ${typeLabel}`;
        }).join('\n');

        // Enviar via FormSubmit com m√©tricas cl√≠nicas em destaque
        const response = await fetch(FORMSUBMIT_CONFIG.endpoint + toEmail, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                _subject: `Di√°rio Motor - ${appState.patient.name} - ${new Date().toLocaleDateString('pt-BR')}`,
                _template: 'table',
                _captcha: 'false',

                // Dados do paciente
                '01. PACIENTE': appState.patient.name,
                '02. CPF': appState.patient.cpf,
                '03. DATA': new Date().toLocaleDateString('pt-BR'),
                '04. INTERVALO': `${metrics.intervalMinutes} minutos`,

                // === M√âTRICAS CL√çNICAS (DESFECHOS PRIM√ÅRIOS) ===
                '05. ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê': '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
                '06. *** M√âTRICAS CL√çNICAS ***': '(Desfechos para Ensaios Cl√≠nicos)',
                '07. ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê': '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',

                '08. TEMPO ON SEM DISCINESIA PROBLEM√ÅTICA': `${metrics.timeOnGood}h (${metrics.pctOnGood}%)`,
                '09. TEMPO ON COM DISCINESIA PROBLEM√ÅTICA': `${metrics.timeOnBad}h (${metrics.pctOnBad}%)`,
                '10. TEMPO OFF': `${metrics.timeOff}h (${metrics.pctOff}%)`,
                '11. TEMPO TOTAL DE VIG√çLIA': `${metrics.totalTime}h`,

                // === CONTAGEM DETALHADA ===
                '12. ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ': '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
                '13. CONTAGEM POR ESTADO': '',
                '14. ON (Bem)': `${metrics.counts.ON} avalia√ß√µes`,
                '15. Discinesia Leve (n√£o problem√°tica)': `${metrics.counts.DYS_NP} avalia√ß√µes`,
                '16. Discinesia Problem√°tica': `${metrics.counts.DYS_P} avalia√ß√µes`,
                '17. OFF (Travado)': `${metrics.counts.OFF} avalia√ß√µes`,
                '18. TOTAL': `${metrics.total} avalia√ß√µes`,

                // === AVALIA√á√ïES INDIVIDUAIS ===
                '19. ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ': '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
                '20. AVALIA√á√ïES DETALHADAS': '\n' + evalListText,

                // === CSV PARA ARQUIVO ===
                '21. ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ': '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
                '22. DADOS CSV (copiar e salvar como .csv)': '\n' + csvFormatted
            })
        });

        const result = await response.json();

        if (result.success === 'true' || result.success === true) {
            return true;
        } else {
            console.error('FormSubmit response:', result);
            return false;
        }
    } catch (error) {
        console.error('Erro ao enviar email:', error);
        return false;
    }
}

/**
 * GERAR CONTE√öDO CSV
 * C√≥digos de status:
 * 1 = OFF
 * 2 = ON (sem discinesia)
 * 3 = DYS_NP (discinesia n√£o problem√°tica)
 * 4 = DYS_P (discinesia problem√°tica)
 */
function generateCSVContent() {
    let csv = 'Nome,CPF,Data,Hora,Timestamp,Status,Status_Codigo,Tipo_Avaliacao\n';

    appState.evaluations.forEach(eval => {
        const statusCode = { 'ON': 2, 'DYS_NP': 3, 'DYS_P': 4, 'OFF': 1 }[eval.status] || 0;
        csv += `"${appState.patient.name}","${appState.patient.cpf}","${eval.dateFormatted}","${eval.timeFormatted}","${eval.timestamp}","${eval.status}",${statusCode},"${eval.type}"\n`;
    });

    return csv;
}

/**
 * GERAR CONTE√öDO JSON
 */
function generateJSONContent() {
    const metrics = calculateClinicalMetrics();

    const data = {
        patient: {
            name: appState.patient.name,
            cpf: appState.patient.cpf
        },
        session: {
            startTime: appState.session.startTime,
            endTime: new Date().toISOString(),
            intervalMinutes: metrics.intervalMinutes,
            totalEvaluations: metrics.total
        },
        // M√©tricas cl√≠nicas padr√£o (desfechos para ensaios cl√≠nicos)
        clinicalMetrics: {
            timeOnWithoutTroublesomeDyskinesia: {
                hours: parseFloat(metrics.timeOnGood),
                percentage: parseFloat(metrics.pctOnGood),
                description: 'Tempo ON sem discinesia problem√°tica (ON + Discinesia leve)'
            },
            timeOnWithTroublesomeDyskinesia: {
                hours: parseFloat(metrics.timeOnBad),
                percentage: parseFloat(metrics.pctOnBad),
                description: 'Tempo ON com discinesia problem√°tica'
            },
            timeOff: {
                hours: parseFloat(metrics.timeOff),
                percentage: parseFloat(metrics.pctOff),
                description: 'Tempo OFF'
            },
            totalWakingTime: {
                hours: parseFloat(metrics.totalTime),
                description: 'Tempo total de vig√≠lia'
            }
        },
        // Contagem por estado
        counts: {
            ON: metrics.counts.ON,
            DYS_NP: metrics.counts.DYS_NP,
            DYS_P: metrics.counts.DYS_P,
            OFF: metrics.counts.OFF
        },
        evaluations: appState.evaluations
    };

    return JSON.stringify(data, null, 2);
}

/**
 * GERAR CONTE√öDO PDF
 */
async function generatePDFContent() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const metrics = calculateClinicalMetrics();

    // T√≠tulo
    doc.setFontSize(18);
    doc.setTextColor(0, 86, 179);
    doc.text('Di√°rio Motor - Parkinson', 105, 20, { align: 'center' });

    // Informa√ß√µes do paciente
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    doc.text(`Paciente: ${appState.patient.name}`, 20, 35);
    doc.text(`CPF: ${appState.patient.cpf}`, 20, 42);
    doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 49);
    doc.text(`Intervalo entre avalia√ß√µes: ${metrics.intervalMinutes} minutos`, 20, 56);

    // M√âTRICAS CL√çNICAS (DESFECHOS)
    doc.setFontSize(14);
    doc.setTextColor(0, 86, 179);
    doc.text('M√âTRICAS CL√çNICAS (Desfechos para Ensaios)', 20, 70);

    doc.autoTable({
        startY: 75,
        head: [['M√©trica', 'Tempo', 'Percentual']],
        body: [
            ['Tempo ON sem discinesia problem√°tica', `${metrics.timeOnGood}h`, `${metrics.pctOnGood}%`],
            ['Tempo ON com discinesia problem√°tica', `${metrics.timeOnBad}h`, `${metrics.pctOnBad}%`],
            ['Tempo OFF', `${metrics.timeOff}h`, `${metrics.pctOff}%`],
            ['Tempo total de vig√≠lia', `${metrics.totalTime}h`, '100%']
        ],
        theme: 'grid',
        headStyles: { fillColor: [0, 86, 179] },
        styles: { fontSize: 10 }
    });

    // Contagem por Estado
    doc.setFontSize(14);
    doc.setTextColor(0, 0, 0);
    doc.text('Contagem por Estado', 20, doc.lastAutoTable.finalY + 15);

    doc.autoTable({
        startY: doc.lastAutoTable.finalY + 20,
        head: [['Estado', 'Quantidade', 'Percentual']],
        body: [
            ['ON (Bem)', metrics.counts.ON, `${metrics.total > 0 ? ((metrics.counts.ON / metrics.total) * 100).toFixed(1) : 0}%`],
            ['Discinesia Leve (n√£o problem√°tica)', metrics.counts.DYS_NP, `${metrics.total > 0 ? ((metrics.counts.DYS_NP / metrics.total) * 100).toFixed(1) : 0}%`],
            ['Discinesia Problem√°tica', metrics.counts.DYS_P, `${metrics.total > 0 ? ((metrics.counts.DYS_P / metrics.total) * 100).toFixed(1) : 0}%`],
            ['OFF (Travado)', metrics.counts.OFF, `${metrics.total > 0 ? ((metrics.counts.OFF / metrics.total) * 100).toFixed(1) : 0}%`],
            ['Total', metrics.total, '100%']
        ],
        theme: 'grid',
        headStyles: { fillColor: [100, 100, 100] },
        styles: { fontSize: 10 }
    });

    // Tabela de avalia√ß√µes
    doc.setFontSize(14);
    doc.text('Avalia√ß√µes Detalhadas', 20, doc.lastAutoTable.finalY + 15);

    const evalRows = appState.evaluations.map(eval => [
        eval.dateFormatted,
        eval.timeFormatted,
        getStatusLabel(eval.status),
        eval.type === 'basal' ? 'Basal' : eval.type === 'manual' ? 'Manual' : 'Autom√°tica'
    ]);

    doc.autoTable({
        startY: doc.lastAutoTable.finalY + 20,
        head: [['Data', 'Hora', 'Estado', 'Tipo']],
        body: evalRows,
        theme: 'striped',
        headStyles: { fillColor: [0, 86, 179] },
        styles: { fontSize: 9 }
    });

    // Rodap√©
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(128);
        doc.text(
            `Gerado em ${new Date().toLocaleString('pt-BR')} - P√°gina ${i} de ${pageCount}`,
            105, 290, { align: 'center' }
        );
    }

    return doc.output('blob');
}

/**
 * DOWNLOADS MANUAIS
 */
function downloadCSV() {
    const csv = generateCSVContent();
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `DiarioMotor_${appState.patient.cpf.replace(/\D/g, '')}_${new Date().toISOString().slice(0, 10)}.csv`;
    link.click();
}

function downloadJSON() {
    const json = generateJSONContent();
    const blob = new Blob([json], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `DiarioMotor_${appState.patient.cpf.replace(/\D/g, '')}_${new Date().toISOString().slice(0, 10)}.json`;
    link.click();
}

async function downloadPDF() {
    const pdfBlob = await generatePDFContent();
    const link = document.createElement('a');
    link.href = URL.createObjectURL(pdfBlob);
    link.download = `DiarioMotor_${appState.patient.cpf.replace(/\D/g, '')}_${new Date().toISOString().slice(0, 10)}.pdf`;
    link.click();
}

/**
 * CONFIGURA√á√ïES
 */
function saveConfig() {
    appState.config.destinationEmail = document.getElementById('config-email').value;
    appState.config.intervalMinutes = parseInt(document.getElementById('config-interval').value) || 30;
    saveState();
    showToast('Configura√ß√µes salvas!');
}

/**
 * UTILIT√ÅRIOS
 */
function updateClock() {
    const now = new Date();
    document.getElementById('current-time').textContent =
        now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    document.getElementById('current-date').textContent =
        now.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

    // Atualizar hora no modal se estiver aberto
    if (document.getElementById('alarm-modal').classList.contains('active')) {
        updateAlarmModalTime();
    }
}

function switchTab(tabId, btn) {
    // Esconder todas as tabs
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

    // Mostrar tab selecionada
    document.getElementById(tabId).classList.add('active');
    btn.classList.add('active');
}

function showToast(message) {
    // Toast simples
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        z-index: 10000;
        animation: fadeInUp 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 2000);
}

/**
 * PERSIST√äNCIA
 */
function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
}

function loadState() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
        const parsed = JSON.parse(saved);
        appState = { ...appState, ...parsed };
    }
}

function resetAllData() {
    if (confirm('Tem certeza que deseja apagar TODOS os dados? Esta a√ß√£o n√£o pode ser desfeita.')) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
    }
}

function resetForNewDay() {
    appState.session = {
        startTime: null,
        isActive: false,
        lastAlarmTime: null
    };
    appState.evaluations = [];
    saveState();

    // Voltar para tela de cadastro (mantendo dados do paciente)
    document.getElementById('diary-screen').style.display = 'none';
    document.getElementById('registration-screen').style.display = 'flex';

    // Preencher dados existentes
    document.getElementById('patient-name').value = appState.patient.name;
    document.getElementById('patient-cpf').value = appState.patient.cpf;
    document.getElementById('destination-email').value = appState.config.destinationEmail;

    closeFinishModal();
}

/**
 * SERVICE WORKER PARA SEGUNDO PLANO
 * Nota: Para funcionar em segundo plano real, precisa de HTTPS e um service worker registrado
 */
if ('serviceWorker' in navigator) {
    // Registrar service worker se dispon√≠vel
    // navigator.serviceWorker.register('/sw.js').then(...);
}

// Manter a p√°gina ativa com Wake Lock API (se dispon√≠vel)
async function requestWakeLock() {
    if ('wakeLock' in navigator) {
        try {
            const wakeLock = await navigator.wakeLock.request('screen');
            console.log('Wake Lock ativo');
            return wakeLock;
        } catch (err) {
            console.log('Wake Lock n√£o dispon√≠vel:', err);
        }
    }
}

// Tentar manter a tela ligada quando o di√°rio estiver ativo
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && appState.session.isActive) {
        requestWakeLock();
    }
});
</script>

</body>
</html>
